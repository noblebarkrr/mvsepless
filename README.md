# MVSepLess - */непростая обёртка*/ для audio-separator и Music-Source-Separation-Training

# Изменения

- Замена librosa.load и write_audio_file на **прямой вызов FFMPEG**, в связи с этим инференс готов принимать видео-файлы с одной аудиодорожкой **(если аудиодорожек больше чем одна, выбирается первая аудиодорожка)**
- Добавление автоматического **уменьшения длины имени выходного файла**, это касается и шаблонов
- Решена проблема с дубликатами ключей шаблона
- Vbach интергрирован в данную ветку репозитория, вместе с этим:
   - Переделан менеджер моделей
   - Заменен Fairseq на эмулятор

- Добавлены новые плагины:
   - Remove Center - Извлечение фантомного центра без ИИ
   - Chainless - Разделение по цепочке (автоматизированный аналог **"Reuse this file"** с MVSEP)
- Обновлены существующие плагины:
   - EnsembLess:
     - Улучшена логика отображения стемов
     - Исправлена ошибка, когда при загруженном аудио выдавало ошибку **"Не указан путь к файлу"**
   - Inverter:
     - Добавлены дополнительные настройки: **тип окна, размер окна, перекрытие**
     - Исправлена проблема с **ресемплингом при разных частотах дискретизации**

# Фишки:

- Динамическое отображение плееров с названиями стемов в Web-UI
- Пакетная обработка файлов
- История разделений
- Возможность выбрать выходные стемы *(если у модели нет целевого инструмента)*
- Инверсия выбранных стемов *(при включенном "Извлечь инструментал")*
- Создание инструментала на 4/6 - стемных моделях, например: ***["bass", "drums", "vocals", "other", "piano", "guitar"]*** (при включенном "Извлечь инструментал")
- Результаты возвращаются в формате списка кортежей - **[("Стем", "Путь/к/файлу")]**
- Поддержка популярных форматов аудио (чтение и запись)
- Явное указание битрейта ***(только через командную строку)***
- Использование шаблона для именования выходных файлов
- Локализованные имена стемов ***(только в Web-UI)***
- Встроенный audio-separator **(Только для VR и MDX моделей)**
- Загрузка аудио из интернета (yt-dlp) прямо в интерфейсе

# Проблемы

- Модель BS-Roformer Inst FNO от unwa, добавленная недавно, сможет запустится только в Google Colab! (на телефоне не работает!)

# Доступные плагины:

- **Vbach** - Форк ***PolGen-RVC 1.2.0***, адаптированный под MVSepLess.<br>Позволяет обрабатывать автоматически стерео файлы *(левый/правый)* или *(фантомный центр/стерео база)*<br> <br>*(Встроено в репозиторий, загружать его отдельно не требуется)*<br> <br>
- **MVSEP API** - Плагин-клиент для MVSEP<br><br>***Плагин активен при заданной переменной окружения MVSEP_API_PLUGIN="True"***<br><br>*(Встроено в репозиторий, загружать его отдельно не требуется)*<br> <br>
- **EnsembLess** - Обьединение результатов моделей в единый результат<br> <br>*(Встроено в репозиторий, загружать его отдельно не требуется)*<br> <br>
- **ChainLess** *NEW!* - Разделение аудио по заданной цепи. Является автоматизированным аналогом "Reuse this file" с сайта MVSEP<br><br>*(Встроено в репозиторий, загружать его отдельно не требуется)*<br> <br>
- **Inverter** - Вычитание одного сигнала из другого.<br><br>*(Встроено в репозиторий, загружать его отдельно не требуется)*<br> <br>
- **Remove Center** *NEW!* - Извлечение фантомного центра без ИИ<br><br>*(Встроено в репозиторий, загружать его отдельно не требуется)*<br> <br>

# Рабочая среда

Google Colab- [![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/noblebarkrr/mvsepless/blob/delta/Mvsepless_Delta_with_Vbach.ipynb)

### Требования для установки

- Python 3.10 - 3.12 (для работы основного кода)
- Актуальная версия Pytorch
- FFMPEG

### Совместимость

- Linux
- Windows (не проверено)

### Переменные окружения

```sh

MVSEPLESS_PYTHON_PATH - путь к интепретатору python (например: "python")

MVSEPLESS_FFPMPEG - путь к бинарному файлу FFMPEG (например: "ffmpeg")

MVSEPLESS_FFPROBE - путь к бинарному файлу FFPROBE (например: "ffprobe")

MVSEPLESS_HISTORY_PATH - путь к файлу истории разделений (например: "/content/history.json")

MVSEPLESS_MODEL_LIST - путь к файлу информации о моделях (например: "/content/models.json")

MVSEPLESS_OUTPUT_DIR - путь к базовой директории вывода (для веб-интерфейса, напрмиер: "/content/output")

MVSEPLESS_PLUGINS_DIR - путь к директории хранения плагинов (например: "/content/plugins")

MVSEPLESS_DOWNLOAD_DIR - путь к директории сохранения скачанных аудио (например: "/content/downloaded")

MVSEPLESS_MODELS_CACHE_DIR - путь к директории кэша моделей (например: "/content/models")

MVSEP_API_PLUGIN - активация плагина (например: "True" - включено, остальные значения переменной не включают плагин)

```


# Использование

### В ячейке блокнота

##### Разделение

```python
# Импорт модуля из multi_inference.py
from multi_inference import MVSEPLESS

# Инициализация класса
mvsepless = MVSEPLESS()

# Создание разделения (как обычно, выбор модели по типу и имени)
output_files = mvsepless.separator.single(
     input_file="/content/test.mp3", # Путь к файлу
     output_dir="/content/output", # Выходная папка
     model_type="bs_roformer", # Тип модели (при model_mode="name")
     model_name="BS-Roformer_SW", # Имя модели (при model_mode="name")
     id=217, # ID модели (при model_mode="id")
     model_mode="name", # Режим выбора модели ["name" - по типу и имени, "id" - по ID]
     ext_inst=True, # "Извлечь инструментал"
     vr_aggr=5, # Агрессивность для VR ARCH моделей
     output_format="opus", # Формат вывода
     output_bitrate="320k", # Битрейт выходного аудио
     template="NAME (STEM)", # Шаблон имени выходного файла
     call_method="cli", # Метод вызова инференса в обёртке
     selected_stems=["drums"], # Выбранные стемы
     save_to_history=False, # Запись в историю разделений ("True - включено, False - выключено")
)
# Создание пакетного разделения
output_files = mvsepless.separator.batch(
     input_list=["/content/test.mp3", "/content/song.mp3"], # Список путей к файлам
     output_dir="/content/output", # Выходная папка
     model_type="bs_roformer", # Тип модели (при model_mode="name")
     model_name="BS-Roformer_SW", # Имя модели (при model_mode="name")
     id=217, # ID модели (при model_mode="id")
     model_mode="name", # Режим выбора модели ["name" - по типу и имени, "id" - по ID]
     ext_inst=True, # "Извлечь инструментал"
     vr_aggr=5, # Агрессивность для VR ARCH моделей
     output_format="opus", # Формат вывода
     output_bitrate="320k", # Битрейт выходного аудио
     template="NAME (STEM)", # Шаблон имени выходного файла
     call_method="cli", # Метод вызова инференса в обёртке
     selected_stems=["drums"], # Выбранные стемы
     save_to_history=False, # Запись в историю разделений ("True - включено, False - выключено")
)

# Отображение списка кортежей
print(output_files) --> [("bass", "/content/output/test (bass).opus"),("drums", "/content/output/test (drums).opus"),("vocals", "/content/output/test (vocals).opus"),("other", "/content/output/test (other).opus"),("piano", "/content/output/test (piano).opus"),("guitar", "/content/output/test (guitar).opus")]

```

##### Запуск веб-интерфейса

```python
# Импорт модуля из multi_inference.py
from multi_inference import MVSEPLESS

# Инициализация класса
mvsepless = MVSEPLESS()

app = mvsepless.gradio_app(
    port=7860, # Порт сервера
    share=True, # Общий доступ
    debug=True, # Отладка (для градио)
    plugins=True, # Поддержка плагинов
    inline=False # Работа прямо в ячейке блокнота (в частности Google Colab)
)
app.launch()

```

##### Получение информации о моделях

```python
# Импорт модуля из multi_inference.py
from multi_inference import MVSEPLESS

# Инициализация класса
mvsepless = MVSEPLESS()

# Получение типов моделей
mvsepless.model_manager.get_mt() # --> ["model_type1", "model_type2"] Пример вывода

# Получение имени моделей
mvsepless.model_manager.get_mn("model_type") # --> ["model_name1", "model_name2"] Пример вывода

# Получение списка стемов
mvsepless.model_manager.get_stems("model_type", "model_name") # --> ["stem1", "stem2"] Пример вывода

# Проверка на наличие целевого инструмента
mvsepless.model_manager.get_tgt_inst("model_type", "model_name") # --> "stem" Пример вывода

# Получение ID модели
mvsepless.model_manager.get_id("model_type", "model_name") # --> 1000 Пример вывода

```

### В командной строке (CLI)

##### Разделение

###### Выбор модели по типу и имени

```sh

использование: multi_inference.py separate [-i ВХОДНОЙ ФАЙЛ/ПАПКА] [-o ВЫХОДНАЯ ПАПКА] [-mt ТИП МОДЕЛИ] 
                                           [-mn ИМЯ МОДЕЛИ] [-inst] [-stems "СТЕМ" "СТЕМ" "СТЕМ"...] 
                                           [-bitrate БИТРЕЙТ] [--format ФОРМАТ ВЫВОДА] 
                                           [--template ШАБЛОН ИМЕНИ ВЫХОДНОГО ФАЙЛА]
                                           [-vr_aggr АГРЕССИВНОСТЬ ДЛЯ VR ARCH МОДЕЛЕЙ]
                                           [-l_out]

Входные аргументы:

-i ВХОДНОЙ ФАЙЛ/ПАПКА, --input ВХОДНОЙ ФАЙЛ/ПАПКА  Определяет путь к входному файлу [строка]
-mt ТИП МОДЕЛИ, --model_type ТИП МОДЕЛИ            Тип модели, используемой в разделении [строка]
-mn ИМЯ МОДЕЛИ, --model_name ИМЯ МОДЕЛИ            Имя модели, используемой в разделении [строка]

Настройки разделения:

-inst, --instrumental                              Инвертирует целевой инструмент/выбранные стемы (работает только с MSST) [булево значение]
-vr_aggr, --vr_arch_aggressive                     Интенсивность извлечения стема на VR ARCH моделях [число]

Выходные настройки:

-o ВЫХОДНАЯ ПАПКА, --output ВЫХОДНАЯ ПАПКА         Определяет директорию, куда будут сохранены стемы [строка]
-stems СТЕМ СТЕМ, --stems СТЕМ СТЕМ                Выбор стемов, которые будут сохранены в папке [список]
-bitrate БИТРЕЙТ, --bitrate БИТРЕЙТ                Битрейт выходных аудио (игнорируется если формат вывода WAV, FLAC и AIFF) [строка]
-of ФОРМАТ ВЫВОДА, --format ФОРМАТ ВЫВОДА          Формат выходного аудио [строка]
--template ШАБЛОН ИМЕНИ ВЫХОДНОГО ФАЙЛА            Форматирование имени выходного файла по шаблону [строка]
-l_out, --list_output                              Отображение результатов разделения [булево значение]


```

###### Выбор модели по ID

```sh

использование: multi_inference.py separate [-i ВХОДНОЙ ФАЙЛ/ПАПКА] [-o ВЫХОДНАЯ ПАПКА]  
                                           [-m_id ID МОДЕЛИ] [-inst] [-stems "СТЕМ" "СТЕМ" "СТЕМ"...] 
                                           [-bitrate БИТРЕЙТ] [--format ФОРМАТ ВЫВОДА] 
                                           [--template ШАБЛОН ИМЕНИ ВЫХОДНОГО ФАЙЛА]
                                           [-vr_aggr АГРЕССИВНОСТЬ ДЛЯ VR ARCH МОДЕЛЕЙ]
                                           [-l_out]

Входные аргументы:

-i ВХОДНОЙ ФАЙЛ/ПАПКА, --input ВХОДНОЙ ФАЙЛ/ПАПКА  Определяет путь к входному файлу [строка]
-m_id ID МОДЕЛИ, --model_id ID МОДЕЛИ              ID модели, используемой в разделении [число]

Настройки разделения:

-inst, --instrumental                              Инвертирует целевой инструмент/выбранные стемы (работает только с MSST) [булево значение]
-vr_aggr, --vr_arch_aggressive                     Интенсивность извлечения стема на VR ARCH моделях [число]

Выходные настройки:

-o ВЫХОДНАЯ ПАПКА, --output ВЫХОДНАЯ ПАПКА         Определяет директорию, куда будут сохранены стемы [строка]
-stems СТЕМ СТЕМ, --stems СТЕМ СТЕМ                Выбор стемов, которые будут сохранены в папке [список]
-bitrate БИТРЕЙТ, --bitrate БИТРЕЙТ                Битрейт выходных аудио (игнорируется если формат вывода WAV, FLAC и AIFF) [строка]
-of ФОРМАТ ВЫВОДА, --format ФОРМАТ ВЫВОДА          Формат выходного аудио [строка]
--template ШАБЛОН ИМЕНИ ВЫХОДНОГО ФАЙЛА            Форматирование имени выходного файла по шаблону [строка]
-l_out, --list_output                              Отображение результатов разделения [булево значение]


```


##### Полчуение информации о моделях

```sh
использование : multi_inference.py list [-l_filter СТЕМ]

Входные аргументы:

-l_filter СТЕМ, --list_filter СТЕМ   Показывает только те модели, в которых есть указанный стем [строка]

```


### В Web-UI

##### Запуск 

```sh
использование: multi_inference.py [--lang ЯЗЫК] app [--share] 
                                  [--debug] [--port ПОРТ]           
                                  [--theme НАЗВАНИЕ ТЕМЫ]       
                      
 
Входные аргументы:

--share                      Общий доступ [булево значение]
--debug                      Отладка ( для gradio )
--port ПОРТ                  Порт сервера [число]
--theme НАЗВАНИЕ ТЕМЫ        Указывает, какую встроенную тему использовать в интерфейсе [строка]
--lang ЯЗЫК                  Язык интерфейса [строка]

```

##### Разделение

1. Загружаете аудио файл или указываете путь к нему
2. Ставите интересующие вас тип и имя модели
4. Нажимаете "Разделить"
5. На выходе должны появится плееры с названиями стемов, которые можете скачать и прослушать

# Плагины (Только для Web-UI)

### Шаблон плагина

```
plugin.py
```

```python

import gradio as gr

TRANSLATIONS = {
    "ru": {
        "test": "Тестовый текст"
    },
    "en": {
        "test": "Test text"
    }
}

CURRENT_LANG = "ru"

def t(key, **kwargs):
    """Функция для получения перевода с подстановкой значений"""
    lang = CURRENT_LANG
    translation = TRANSLATIONS.get(lang, {}).get(key, key)
    return translation.format(**kwargs) if kwargs else translation

def set_language(lang):
    global CURRENT_LANG
    CURRENT_LANG = lang

def plugin_name(): # Имя плагина (вкладки в интерфейсе)
    return "Plugin"

def plugin(lang): # аргумент lang используется для применения языка, такого же как и в интерфейсе
    set_language(lang)
    gr.Markdown(t("test"))


```













